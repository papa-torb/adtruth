var AdTruth=function(){"use strict";function t(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function e(){const e="_adtruth_session";try{let i=sessionStorage.getItem(e);return i||(i=t(),sessionStorage.setItem(e,i)),i}catch(e){return t()}}function i(){const e="_adtruth_visitor";try{let i=localStorage.getItem(e);return i||(i=t(),localStorage.setItem(e,i)),i}catch(i){try{let i=sessionStorage.getItem(e);return i||(i=t(),sessionStorage.setItem(e,i)),i}catch(e){return t()}}}function n(){const t={screen:`${screen.width}x${screen.height}x${screen.colorDepth}`,timezone:s(),timezoneOffset:(new Date).getTimezoneOffset(),hardwareConcurrency:navigator.hardwareConcurrency||0,deviceMemory:navigator.deviceMemory||0};return{hash:function(t){const e=JSON.stringify(t);let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i&=i;return Math.abs(i).toString(36)}(t),details:t}}function s(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(t){return"unknown"}}class a{constructor(){this.pageLoadTime=Date.now(),this.firstInteractionTime=null,this.lastInteractionTime=null,this.clickCount=0,this.clickTimes=[],this.maxScrollDepth=0,this.scrollEvents=0,this.mouseSamples=[],this.lastMouseSample=0,this.mouseMovementDetected=!1,this.touchSamples=[],this.touchStartTime=null,this.touchStartPos=null,this.tapCount=0,this.tapTimes=[],this.swipeDetected=!1,this.setupListeners()}setupListeners(){document.addEventListener("click",this.handleClick.bind(this),{passive:!0}),document.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),document.addEventListener("mousemove",this.handleMouseMove.bind(this),{passive:!0}),document.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!0}),document.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!0}),document.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!0});const t=()=>{this.firstInteractionTime||(this.firstInteractionTime=Date.now())};["click","keydown","touchstart","mousemove"].forEach(e=>{document.addEventListener(e,t,{passive:!0,once:!0})})}handleClick(t){const e=Date.now();this.clickCount++,this.clickTimes.push(e),this.lastInteractionTime=e,this.clickTimes.length>20&&this.clickTimes.shift()}handleScroll(){this.scrollEvents++;const t=window.innerHeight,e=document.documentElement.scrollHeight,i=((window.pageYOffset||document.documentElement.scrollTop)+t)/e;i>this.maxScrollDepth&&(this.maxScrollDepth=i)}handleMouseMove(t){const e=Date.now();this.mouseMovementDetected=!0,e-this.lastMouseSample<100||(this.lastMouseSample=e,this.mouseSamples.push({x:t.clientX,y:t.clientY,t:e}),this.mouseSamples.length>50&&this.mouseSamples.shift())}handleTouchStart(t){const e=Date.now();if(t.touches.length>0){const i=t.touches[0];this.touchStartTime=e,this.touchStartPos={x:i.clientX,y:i.clientY},this.tapTimes.push(e),this.tapTimes.length>10&&this.tapTimes.shift()}}handleTouchMove(t){if(t.touches.length>0&&this.touchStartPos){const e=t.touches[0];this.touchSamples.push({x:e.clientX,y:e.clientY,t:Date.now()}),this.touchSamples.length>30&&this.touchSamples.shift()}}handleTouchEnd(t){if(!this.touchStartTime||!this.touchStartPos)return;const e=Date.now()-this.touchStartTime,i=t.changedTouches[0],n=i.clientX,s=i.clientY,a=n-this.touchStartPos.x,r=s-this.touchStartPos.y,o=Math.sqrt(a*a+r*r);e<300&&o<10&&this.tapCount++,o>50&&(this.swipeDetected=!0),this.touchStartTime=null,this.touchStartPos=null}calculateAvgInterval(){if(this.clickTimes.length<2)return null;let t=0;for(let e=1;e<this.clickTimes.length;e++)t+=this.clickTimes[e]-this.clickTimes[e-1];return Math.round(t/(this.clickTimes.length-1))}analyzeMousePatterns(){if(this.mouseSamples.length<3)return null;const t=[],e=[];for(let i=1;i<this.mouseSamples.length;i++){const n=this.mouseSamples[i-1],s=this.mouseSamples[i],a=s.x-n.x,r=s.y-n.y,o=(s.t-n.t)/1e3,h=Math.sqrt(a*a+r*r)/o;if(t.push(h),i>1){const t=n.x-this.mouseSamples[i-2].x,s=n.y-this.mouseSamples[i-2].y,o=Math.atan2(r,a)-Math.atan2(s,t);e.push(Math.abs(o))}}const i=t.reduce((t,e)=>t+e,0)/t.length,n=this.calculateVariance(t),s=e.length>0?e.reduce((t,e)=>t+e,0)/e.length:0;return{avgVelocity:Math.round(i),velocityVariance:Math.round(n),avgAngleChange:Math.round(100*s)/100,sampleCount:this.mouseSamples.length,hasHumanPatterns:n>100&&s>.1}}calculateVariance(t){if(0===t.length)return 0;const e=t.reduce((t,e)=>t+e,0)/t.length;return t.map(t=>Math.pow(t-e,2)).reduce((t,e)=>t+e,0)/t.length}analyzeTouchPatterns(){let t=null;if(this.tapTimes.length>=2){let e=0;for(let t=1;t<this.tapTimes.length;t++)e+=this.tapTimes[t]-this.tapTimes[t-1];t=Math.round(e/(this.tapTimes.length-1))}let e=null;if(this.touchSamples.length>=2){const t=this.touchSamples[0],i=this.touchSamples[this.touchSamples.length-1],n=i.x-t.x,s=i.y-t.y,a=Math.sqrt(n*n+s*s),r=(i.t-t.t)/1e3;e=r>0?Math.round(a/r):0}return{tapCount:this.tapCount,avgTapInterval:t,swipeDetected:this.swipeDetected,swipeVelocity:e,touchSampleCount:this.touchSamples.length}}getMetrics(){const t=Date.now()-this.pageLoadTime,e=this.analyzeMousePatterns(),i=this.analyzeTouchPatterns();return{timeOnPage:t,timeToFirstInteraction:this.firstInteractionTime?this.firstInteractionTime-this.pageLoadTime:null,timeToFirstClick:this.clickTimes.length>0?this.clickTimes[0]-this.pageLoadTime:null,clickCount:this.clickCount,avgClickInterval:this.calculateAvgInterval(),hasInteracted:null!==this.firstInteractionTime,scrollDepth:Math.round(100*this.maxScrollDepth)/100,scrollEvents:this.scrollEvents,mouseMovementDetected:this.mouseMovementDetected,mousePatterns:e,touchPatterns:i}}cleanup(){}}const r=new class{constructor(){this.apiKey=null,this.apiEndpoint="https://api.adtruth.io/track/",this.initialized=!1,this.debug=!1,this.behaviorTracker=null,this.fingerprint=null,this.hasUnloadListener=!1,this.periodicTimer=null,this.unloadEventSent=!1}init(t,e={}){try{if(this.initialized)return;if(!t)return void this.log("AdTruth: API key is required");this.apiKey=t,this.debug=e.debug||!1,e.endpoint&&(this.apiEndpoint=e.endpoint),this.initialized=!0,this.log("AdTruth: Initialized"),this.behaviorTracker=new a,this.fingerprint=n();try{this.canvasFingerprint=function(){try{const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)return null;t.width=200,t.height=50,e.textBaseline="top",e.font="14px Arial",e.textBaseline="alphabetic",e.fillStyle="#f60",e.fillRect(125,1,62,20),e.fillStyle="#069",e.font="11pt no-real-font-123",e.fillText("AdTruthðŸ”’",2,15),e.fillStyle="rgba(102, 204, 0, 0.7)",e.font="18pt Arial",e.fillText("AdTruth",4,17);const i=t.toDataURL(),n=i.slice(-50);let s=0;for(let t=0;t<i.length;t++)s=(s<<5)-s+i.charCodeAt(t),s&=s;return{hash:Math.abs(s).toString(36),partial:n}}catch(t){return null}}()}catch(t){this.log("AdTruth: Canvas fingerprinting failed (browser restriction)",t),this.canvasFingerprint=null}this.setupUnloadTracking(),e.periodicUpdates&&this.startPeriodicUpdates(e.updateInterval||3e4)}catch(t){this.log("AdTruth: Initialization error",t)}}setupUnloadTracking(){if(this.hasUnloadListener)return;const t=()=>{try{if(!this.initialized||!this.behaviorTracker)return;if(this.unloadEventSent)return void this.log("AdTruth: Final event already sent");this.unloadEventSent=!0,this.stopPeriodicUpdates();const t=this.collectData("pageview"),e=JSON.stringify(t),i=new Blob([e]).size;this.log("AdTruth: Sending final event on page unload"),this.log(`AdTruth: Payload size: ${i} bytes`),this.log("AdTruth: Behavior data:",t.behavior),this.sendViaFetch(e)}catch(t){this.log("AdTruth: Error sending final event",t)}};window.addEventListener("beforeunload",t),window.addEventListener("pagehide",t),window.addEventListener("unload",t),this.hasUnloadListener=!0,this.log("AdTruth: Page unload tracking enabled")}startPeriodicUpdates(t=3e4){this.periodicTimer||(this.periodicTimer=setInterval(()=>{try{this.initialized&&this.behaviorTracker&&(this.log("AdTruth: Sending periodic update"),this.track())}catch(t){this.log("AdTruth: Error in periodic update",t)}},t),this.log(`AdTruth: Periodic updates enabled (every ${t}ms)`))}stopPeriodicUpdates(){this.periodicTimer&&(clearInterval(this.periodicTimer),this.periodicTimer=null,this.log("AdTruth: Periodic updates stopped"))}track(t="pageview"){try{if(!this.initialized)return void this.log("AdTruth: Not initialized. Call init() first.");const e=this.collectData(t);this.sendData(e)}catch(t){this.log("AdTruth: Tracking error",t)}}collectData(t){const n=window.location.href,s=function(t){const e={};try{const i=new URL(t).searchParams;["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(t=>{const n=i.get(t);n&&(e[t]=n)});const n=i.get("gclid");n&&(e.gclid=n);const s=i.get("fbclid");s&&(e.fbclid=s)}catch(t){}return e}(n),a={user_agent:navigator.userAgent,language:navigator.language,languages:navigator.languages?Array.from(navigator.languages).join(","):"",platform:navigator.platform,vendor:navigator.vendor||"",cookieEnabled:navigator.cookieEnabled,doNotTrack:navigator.doNotTrack||"unknown",maxTouchPoints:navigator.maxTouchPoints||0,hardwareConcurrency:navigator.hardwareConcurrency||0,deviceMemory:navigator.deviceMemory||0},r=function(){const t="ontouchstart"in window,e="undefined"!=typeof matchMedia&&matchMedia("(pointer: fine)").matches,i="undefined"!=typeof matchMedia&&matchMedia("(hover: hover)").matches;return{hasTouch:t,hasMouse:e,hasHover:i,maxTouchPoints:navigator.maxTouchPoints||0,inputInconsistency:t&&e&&i}}(),o=this.behaviorTracker?this.behaviorTracker.getMetrics():{};return{event_type:t,timestamp:(new Date).toISOString(),session_id:e(),visitor_id:i(),page:{url:n,title:document.title||"",referrer:document.referrer||""},utm:{source:s.utm_source||null,medium:s.utm_medium||null,campaign:s.utm_campaign||null,term:s.utm_term||null,content:s.utm_content||null},click_ids:{gclid:s.gclid||null,fbclid:s.fbclid||null},browser:{...a,screen:{width:screen.width,height:screen.height,colorDepth:screen.colorDepth},viewport:{width:window.innerWidth,height:window.innerHeight}},fingerprint:{hash:this.fingerprint?this.fingerprint.hash:null,timezone:this.fingerprint?this.fingerprint.details.timezone:null,timezoneOffset:this.fingerprint?this.fingerprint.details.timezoneOffset:null,canvas:this.canvasFingerprint?this.canvasFingerprint.hash:null},input:r,behavior:o}}sendData(t){const e=JSON.stringify(t);this.sendViaFetch(e)}sendViaFetch(t){const e=new Blob([t]).size;e>61440&&this.log(`AdTruth: Warning - Payload size ${e} bytes exceeds keepalive limit`);const i=new AbortController,n=setTimeout(()=>i.abort(),5e3);fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.apiKey},body:t,keepalive:!0,credentials:"omit",signal:i.signal}).then(()=>{clearTimeout(n),this.log("AdTruth: Data sent via fetch")}).catch(t=>{clearTimeout(n),"AbortError"===t.name?this.log("AdTruth: Request timeout"):this.log("AdTruth: Failed to send data",t)})}log(...t){this.debug&&"undefined"!=typeof console&&console.log&&console.log(...t)}},o={init:function(t,e){try{r.init(t,e)}catch(t){console.error("AdTruth: Initialization failed",t)}},trackPageview:function(){try{r.track("pageview")}catch(t){console.error("AdTruth: Tracking failed",t)}},track:function(t,e){try{r.track(t||"pageview")}catch(t){console.error("AdTruth: Tracking failed",t)}},getMetrics:function(){return r.behaviorTracker?{behavior:r.behaviorTracker.getMetrics(),fingerprint:r.fingerprint,canvasFingerprint:r.canvasFingerprint}:{error:"Tracker not initialized. Call AdTruth.init() first."}},version:"0.2.1",get _debug(){return r}};
/**
   * AdTruth SDK - Open-source fraud detection for paid advertising
   * @version 0.2.1
   * @license MIT
   */return"undefined"!=typeof document&&document.addEventListener("DOMContentLoaded",function(){const t=document.querySelector("script[data-adtruth-api-key]");if(t){const e=t.getAttribute("data-adtruth-api-key"),i="true"===t.getAttribute("data-adtruth-debug");o.init(e,{debug:i})}}),o}();
